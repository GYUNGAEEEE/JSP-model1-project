# Servlet?

> - HTML/CSS/JS: 정적사이트      
> - JSP(Java): 동적사이트 → "Dynamic Web Project"

- login.jsp
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%!
	public void init() throws ServletException {
		System.out.println("login.jsp 초기화");
	}
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>로그인</title>
</head>
<body>
<form action="loginProc.jsp" method="post">
	<input type="text" name="userid"><br/>
	<input type="password" name="userpw"><br/>
	<input type="submit" value="로그인">
</form>
</body>
</html>
```
- loginProc.jsp
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%
	String userid = request.getParameter("userid");
	String userpw = request.getParameter("userpw");
	
	if(userid.equals(userpw)) {
		response.sendRedirect("/main.jsp");
	} else {
		response.sendRedirect("/login.jsp");
	}
%>
```
웹 브라우저와 웹 애플리케이션 서버간의 통신(요청-처리-응답)을 위해 JSP 파일이 매개체가 된다.
클라이언트는 먼저 서버에게 "login.jsp"를 요청하여 사용자에게 로그인 정보를 입력할 수 있는 form을 받아온다. 이후, 사용자가 해당 form에 입력한 정보를 처리하고 응답해주기 위해 "loginProc.jsp"를 추가적으로 요청하게 된다.
이런 방식으로 애플리케이션의 기능이 확장될 때마다 필요한 JSP 파일이 추가될 것이다.

그런데, "loginProc.jsp"는 동적인 페이지를 생성하는 것이 아니라, 처리 로직이 담긴 파일이다.
JSP 파일은 주로 HTML 코드와 섞여 동적인 페이지를 생성하는 역할을 하는데, "loginProc.jsp"는 그러한 목적에 부합하지 않는 것처럼 보인다.
이렇게, 이전에 사용된 방식은 각 요청에 대해 전부 JSP 파일을 요청하는 형태였다.
***
## JSP 생명 주기(Life Cycle)
JSP 파일(login.jsp)은 Java 서블릿 소스 코드(login_jsp.java)로 변환이 되고, 변환된 서블릿 소스 코드는 Java 컴파일러에 의해 컴파일되어 바이트 코드(login_jsp.class)로 변환된다.
컴파일된 JSP 클래스는 웹 애플리케이션의 클래스 로더에 의해 로딩되고, 클래스가 로딩되면 웹 컨테이너는 해당 JSP 페이지에 대한 인스턴스를 생성한다.
생성된 JSP 인스턴스는 'jspInit()' 메서드를 호출하여 초기화되고, 클라이언트로부터의 각 요청에 대해 요청을 처리하고 응답을 생성하는 역할의 'service()' 메서드가 호출된다.
JSP 라이프 사이클이 끝나면 'jspDstroy()' 메서드가 호출되어 마무리 작업을 수행한다. 
JSP 페이지의 인스턴스는 더 이상 사용되지 않을 때, Java 가비지 컬렉터에 의해 수거된다.

즉, JSP는 내부적으로 Servlet으로 변환되어 실행된다.
```
C:\webStudy\wk\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\work\Catalina\localhost\servletex\org\apache\jsp\login_jsp.java
```
(https://tomcat.apache.org/tomcat-4.0-doc/jasper/docs/api/org/apache/jasper/runtime/HttpJspBase.html)   
"login_jsp.java"는 'HttpJspBase'를 상속하고 있고, 'HttpJspBase'는 'HttpServlet'을 상속하고 있으며, 'HttpServlet'은 'GenericServlet'을 상속하고 있다.
따라서, "login_jsp.java"는 Servlet이며 JSP가 곧 Servlet이다!
***
## Servlet? 
웹 애플리케이션에서 클라이언트의 요청을 처리하는 자바 클래스이다.
이 클래스들은 javax.servlet 패키지에 정의되어 있으며, 주로 HTTP를 기반으로 하는 웹 프로토콜을 다루기 위한 HttpServlet 클래스를 상속하여 만들어진다.
***
Servlet을 사용하여 클라이언트의 요청을 처리해보자.
1. HttpServlet 상속 및 메서드 재정의
- LoginServlet.java
```java
package servletex;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class LoginServlet extends HttpServlet {
	@Override
	public void init() throws ServletException {
		System.out.println("로그인 서블릿 초기화");
	}
	
	@Override
	public void destroy() {
		System.out.println("로그인 서블릿 소멸");
	}
	
	@Override
	protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		System.out.println("로그인 서비스!");
	}
}
```
2. 서블릿 등록과 경로 매핑

서블릿을 등록함으로써 웹 애플리케이션 컨테이너(Tomcat, Jetty 등)가 해당 서블릿을 식별하고 관리할 수 있다.
등록된 서블릿은 웹 애플리케이션의 서블릿 컨텍스트 내에서 사용 가능하게 된다.

클라이언트가 특정 URL로 요청을 보내면, 경로 매핑은 해당 요청을 처리할 서블릿을 결정한다.
- web.xml
```xml
<!-- 서블릿 등록 -->
<servlet>
 <servlet-name>loginServlet</servlet-name>
 <servlet-class>servletex.LoginServlet</servlet-class>
</servlet>

<!-- 경로 매핑 -->
<servlet-mapping>
  <servlet-name>loginServlet</servlet-name>
  <url-pattern>/login</url-pattern>
</servlet-mapping>
```
이렇게 설정된 서블릿은 클라이언트의 요청에 대한 처리를 담당하게 되며, 이를 통해 동적인 웹 애플리케이션 로직을 Java 코드로 구현할 수 있다.
```
http://localhost:8080/servletex/login
```
```
로그인 서블릿 초기화
로그인 서비스!
```
***
앞에서 JSP로 구현했던 내용을 Servlet으로 구현해보자.
- LoginServlet.java
```java
package servletex;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class LoginServlet extends HttpServlet {
	@Override
	public void init() throws ServletException {
		System.out.println("로그인 서블릿 초기화");
	}
	
	@Override
	public void destroy() {
		System.out.println("로그인 서블릿 소멸");
	}
	
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		PrintWriter pw = new PrintWriter(resp.getOutputStream());
		pw.println(
				"<!DOCTYPE html>\r\n" +
				"<html>\r\n" +
				"<head>\r\n" +
				"<meta charset=\"UTF-8\">\r\n" +
				"<title>로그인</title>\r\n" +
				"</head>\r\n" +
				"<body>\r\n" +
				"<form action=\"loginProc.jsp\" method=\"post\">\r\n" +
				"	<input type=\"text\" name=\"userid\"><br/>\r\n" +
				"	<input type=\"password\" name=\"userpw\"><br/>\r\n" +
				"	<input type=\"submit\" value=\"로그인\">\r\n" +
				"</form>\r\n" +
				"</body>\r\n" +
				"</html>\r\n");
		pw.flush();
	}
}
```
이 코드는 JSP 없이 Servlet을 사용하여 웹 서비스를 개발하기 위해, Java 코드 내에서 동적인 웹 페이지를 생성하고 클라이언트에 제공하고 있다.
하지만 너무 불편하다! 그래서 JSP 파일을 사용하게 된다.
- LoginServlet.java
```java
package servletex;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class LoginServlet extends HttpServlet {
	@Override
	public void init() throws ServletException {
		System.out.println("로그인 서블릿 초기화");
	}
	
	@Override
	public void destroy() {
		System.out.println("로그인 서블릿 소멸");
	}
	
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		req.getRequestDispatcher("/login.jsp").forward(req, resp);
	}
}
```
Servlet에서 JSP 페이지로 제어를 전달하도록 하였다.

이를 통해 서블릿과 JSP 페이지 사이에서 작업을 나누거나, 동적인 웹 페이지를 생성하는 로직을 JSP에서 담당하도록 하는 등의 목적으로 사용된다.
JSP는 주로 화면 표현에 특화되어 있으므로, 이러한 형태의 forward를 통해 역할을 나누는 것이 웹 애플리케이션 개발에서 효과적인 구조를 갖출 수 있다.

나머지를 완성하면 다음과 같다.
- login.jsp
```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%!
	public void init() throws ServletException {
		System.out.println("login.jsp 초기화");
	}
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>로그인</title>
</head>
<body>
<form method="post">
	<input type="text" name="userid"><br/>
	<input type="password" name="userpw"><br/>
	<input type="submit" value="로그인">
</form>
</body>
</html>
```
form 태그의 action 속성을 지정하지 않으면, 해당 폼은 현재 페이지로 데이터를 전송한다.
즉, 사용자가 폼을 제출하면 폼 데이터는 현재 페이지로 전송되어 서버로 보내진다.
이때 주소창의 URL이 변경되지 않으며, 데이터는 현재 페이지에서 처리된다.
서버 측에서는 폼 데이터를 처리하는 로직이 필요하며, 이때 서블릿을 사용한다.
- LoginServlet.java
```java
package servletex;

import java.io.IOException;
import java.io.PrintWriter;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class LoginServlet extends HttpServlet {
	@Override
	public void init() throws ServletException {
		System.out.println("로그인 서블릿 초기화");
	}
	
	@Override
	public void destroy() {
		System.out.println("로그인 서블릿 소멸");
	}
	
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		req.getRequestDispatcher("/login.jsp").forward(req, resp);
	}
	
	@Override
	protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		String userid = req.getParameter("userid");
		String userpw = req.getParameter("userpw");
		
		if(userid.equals(userpw)) {
			resp.sendRedirect("/main.jsp");
			System.out.println("로그인 성공!");
		} else {
			resp.sendRedirect("/login.jsp");
			System.out.println("로그인 실패!");
		}
	}
}
```
"loginProc.jsp"의 Java 코드는 이제 LoginServlet의 doPost() 메서드에서 처리하면 된다.

> 참고자료: https://www.youtube.com/watch?v=g5KmJAIIEeI&t=21s
